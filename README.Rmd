---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "60%"
)

library(spng)

# Makevars options to do some deep testing for CRAN

# Type conversions are sane
# PKG_FLAG=-Wconversion

# Pointer overflow checks i.e. dodgy pointer arithmetic
# PKG_CFLAGS+=-fsanitize=pointer-overflow -fsanitize-trap=pointer-overflow
# Then run in the debugger:
# R -d lldb 
# run
# testthat::test_local()
```

# spng


<!-- badges: start -->
![](https://img.shields.io/badge/cool-useless-green.svg)
<!-- badges: end -->

`spng` offers in-memory decompression of PNG images to vectors of raw values.

This is useful if you have bytes representing a PNG image (e.g. from a database)
and need to decompress these to an array representation within R.

`spng` is a R wrapper for [libspng](https://github.com/randy408/libspng) - current v0.7.4



* [libspng API docs](https://libspng.org/docs/api/)


## To Do

* `read_png()`
    * Properly describe `flags`
* `write.png()`
    * Add support for RGB `raster` images 
    * Handle R colour names in `raster` images. e.g. `white` instead of `#FFFFFFFF`
    * Extend compression level and filter settings to match PNG standard
* `get_png_info()`
    * Add descriptions for all the codes e.g. `compression_method`
* Docs
    * Benchmark with compression level and filter settings against `{png}`

## Installation

You can install from [GitHub](https://github.com/coolbutuseless/spng) with:

``` r
# install.package('remotes')
remotes::install_github('coolbutuseless/spng')
```

## What's in the box

* `read_png(raw_vec, type, flags)` 
* `write_png()`
* `get_png_info(raw_vec)` - interrogate a vector of raw values containing a PNG image
  to determine image information i.e. width, height, bit_depth, color_type, 
  compression_method, filter_method, interlace_method.
  

## Example: Decompress a PNG in memory

```{r example}
library(spng)

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# A PNG file everyone should have!
# Read in the raw bytes
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
png_file <- system.file("img", "Rlogo.png", package="png")
png_data <- readBin(png_file, 'raw', n = file.size(png_file))
png_data[1:100]
```


```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Get info about the PNG 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
(get_png_info <- spng::get_png_info(png_data))
```


### Read PNG as native raster

```{r}
nara <- read_png(png_data, type = 'nara')
grid::grid.raster(nara, interpolate = FALSE)
```


```{r eval=FALSE, echo=FALSE}
library(png)
bench::mark(
  # read_png(png_data),
  read_png(png_data, type = 'nara'),
  read_png(png_data, type = 'ras'),
  read_png(png_data, type = 'rgba'),
  read_png(png_data, type = 'rgb'),
  readPNG(png_data, native = FALSE),
  readPNG(png_data, native = FALSE) |> as.raster(),
  readPNG(png_data, native = TRUE),
  check = FALSE
)
```



```{r echo=FALSE, eval = FALSE}
im <- matrix("#445566FF", 100, 150)
as.raster(im)
grid.raster(im)
```


### Read PNG as raster

```{r}
ras <- read_png(png_data, type = 'raster')
plot(ras, interpolate = FALSE)
```


### Read PNG as RGBA array

```{r}
arr <- read_png(png_data, type = 'rgba')
plot(as.raster(arr), interpolate = FALSE)
```



### Read PNG as RGB array

Ignoring any alpha channel in the image.

```{r}
arr <- read_png(png_data, type = 'rgb')
plot(as.raster(arr), interpolate = FALSE)
```



## Acknowledgements

* R Core for developing and maintaining the language.
* CRAN maintainers, for patiently shepherding packages onto CRAN and maintaining
  the repository
